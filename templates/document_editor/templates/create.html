{% extends 'base.html' %}
{% load static %}

{% block title %}Create Template - Document Editor{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'document_editor/css/document-editor.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'document_editor:dashboard' %}">Document Editor</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'document_editor:template_list' %}">Templates</a></li>
                            <li class="breadcrumb-item active">Create</li>
                        </ol>
                    </nav>
                    <h1 class="h3 mb-0">ðŸ“‹ Create Template</h1>
                </div>
                <div>
                    <a href="{% url 'document_editor:template_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Templates
                    </a>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="templateForm">
        {% csrf_token %}
        <div class="row">
            <!-- Main Form -->
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Template Information</h5>
                    </div>
                    <div class="card-body">
                        <!-- Template Name -->
                        <div class="mb-3">
                            <label for="name" class="form-label">
                                Template Name <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="name" name="name" required 
                                   placeholder="e.g., Service Agreement Template">
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3" 
                                      placeholder="Brief description of when to use this template..."></textarea>
                        </div>

                        <!-- Category -->
                        <div class="mb-3">
                            <label for="category" class="form-label">Category <span class="text-danger">*</span></label>
                            <select class="form-control" id="category" name="category" required>
                                <option value="">Select Category</option>
                                <option value="contract">Contracts</option>
                                <option value="letter">Letters</option>
                                <option value="legal">Legal Documents</option>
                                <option value="business">Business</option>
                                <option value="personal">Personal</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <!-- Content -->
                        <div class="mb-3">
                            <label for="content" class="form-label">
                                Template Content <span class="text-danger">*</span>
                            </label>
                            <div id="content-editor" style="min-height: 400px; border: 1px solid #ddd;">
                                <!-- Rich text editor will be initialized here -->
                            </div>
                            <textarea name="content" id="content" style="display: none;" required></textarea>
                            <small class="form-text text-muted">
                                Use placeholders like [CLIENT_NAME], [DATE], [AMOUNT] for dynamic content.
                            </small>
                        </div>

                        <!-- Variables/Placeholders -->
                        <div class="mb-3">
                            <label for="variables" class="form-label">Template Variables</label>
                            <div id="variablesContainer">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" placeholder="Variable name (e.g., CLIENT_NAME)" 
                                           name="variable_names[]">
                                    <input type="text" class="form-control" placeholder="Description" 
                                           name="variable_descriptions[]">
                                    <button type="button" class="btn btn-outline-secondary" onclick="addVariable()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <small class="form-text text-muted">
                                Define variables that will be replaced when using this template.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Preview -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">Preview</h5>
                    </div>
                    <div class="card-body">
                        <div id="template-preview" style="min-height: 200px; border: 1px solid #ddd; padding: 20px; background: white;">
                            <p class="text-muted text-center">Start typing content above to see preview...</p>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="card mt-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="submit" name="action" value="save" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Template
                                </button>
                                <button type="submit" name="action" value="save_and_test" class="btn btn-success">
                                    <i class="fas fa-flask"></i> Save & Test
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-info" onclick="testTemplate()">
                                    <i class="fas fa-play"></i> Test Template
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="loadSampleTemplate()">
                                    <i class="fas fa-lightbulb"></i> Load Sample
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4 mb-4">
                <!-- Template Settings -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Template Settings</h5>
                    </div>
                    <div class="card-body">
                        <!-- Access Level -->
                        <div class="mb-3">
                            <label for="access_level" class="form-label">Access Level</label>
                            <select class="form-control" id="access_level" name="access_level">
                                <option value="private">Private (Only me)</option>
                                <option value="team">Team (My organization)</option>
                                <option value="public">Public (Everyone)</option>
                            </select>
                            <small class="form-text text-muted">
                                Controls who can view and use this template.
                            </small>
                        </div>

                        <!-- Language -->
                        <div class="mb-3">
                            <label for="language" class="form-label">Language</label>
                            <select class="form-control" id="language" name="language">
                                <option value="en">English</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="it">Italian</option>
                                <option value="pt">Portuguese</option>
                            </select>
                        </div>

                        <!-- Tags -->
                        <div class="mb-3">
                            <label for="tags" class="form-label">Tags</label>
                            <input type="text" class="form-control" id="tags" name="tags" 
                                   placeholder="contract, legal, business" 
                                   data-bs-toggle="tooltip" 
                                   title="Separate tags with commas">
                        </div>

                        <!-- Version Control -->
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="enable_versioning" name="enable_versioning" checked>
                            <label class="form-check-label" for="enable_versioning">
                                Enable Version Control
                            </label>
                        </div>

                        <!-- Allow Comments -->
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="allow_comments" name="allow_comments" checked>
                            <label class="form-check-label" for="allow_comments">
                                Allow Comments & Reviews
                            </label>
                        </div>

                        <!-- Auto-format -->
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="auto_format" name="auto_format" checked>
                            <label class="form-check-label" for="auto_format">
                                Auto-format when creating documents
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Quick Insertions -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">Quick Insertions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertPlaceholder('[DATE]')">
                                <i class="fas fa-calendar"></i> Date
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertPlaceholder('[CLIENT_NAME]')">
                                <i class="fas fa-user"></i> Client Name
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertPlaceholder('[COMPANY_NAME]')">
                                <i class="fas fa-building"></i> Company Name
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertPlaceholder('[ADDRESS]')">
                                <i class="fas fa-map-marker-alt"></i> Address
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertPlaceholder('[AMOUNT]')">
                                <i class="fas fa-dollar-sign"></i> Amount
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="insertSignatureBlock()">
                                <i class="fas fa-signature"></i> Signature Block
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sample Templates -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">Sample Templates</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadSample('service_agreement')">
                                Service Agreement
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadSample('nda')">
                                Non-Disclosure Agreement
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadSample('business_letter')">
                                Business Letter
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="loadSample('invoice')">
                                Invoice Template
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Template Statistics -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h6 class="text-primary" id="word-count">0</h6>
                                <small class="text-muted">Words</small>
                            </div>
                            <div class="col-6">
                                <h6 class="text-success" id="variable-count">0</h6>
                                <small class="text-muted">Variables</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Test Template Modal -->
<div class="modal fade" id="testModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testForm">
                    <div id="testVariables">
                        <!-- Test variables will be populated here -->
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Preview:</label>
                        <div id="testPreview" style="border: 1px solid #ddd; padding: 20px; min-height: 200px; background: white;">
                            <!-- Test preview will be shown here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="createDocumentFromTest()">
                    <i class="fas fa-file-plus"></i> Create Document
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.ckeditor.com/ckeditor5/35.3.2/classic/ckeditor.js"></script>
<script>
let editor;

// Initialize CKEditor
ClassicEditor
    .create(document.querySelector('#content-editor'), {
        toolbar: [
            'heading', '|',
            'bold', 'italic', 'underline', '|',
            'bulletedList', 'numberedList', '|',
            'indent', 'outdent', '|',
            'link', 'insertTable', '|',
            'undo', 'redo'
        ]
    })
    .then(editorInstance => {
        editor = editorInstance;
        
        // Update preview and stats on content change
        editor.model.document.on('change:data', () => {
            updatePreview();
            updateStats();
            updateHiddenTextarea();
        });
        
        // Initial update
        updateStats();
    })
    .catch(error => {
        console.error(error);
    });

function updatePreview() {
    if (!editor) return;
    
    const content = editor.getData();
    const preview = document.getElementById('template-preview');
    
    if (content.trim()) {
        preview.innerHTML = content;
    } else {
        preview.innerHTML = '<p class="text-muted text-center">Start typing content above to see preview...</p>';
    }
}

function updateStats() {
    if (!editor) return;
    
    const content = editor.getData();
    const text = content.replace(/<[^>]*>/g, ''); // Strip HTML
    const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
    
    // Count variables (placeholders in square brackets)
    const variables = (content.match(/\[[\w_]+\]/g) || []).length;
    
    document.getElementById('word-count').textContent = words;
    document.getElementById('variable-count').textContent = variables;
}

function updateHiddenTextarea() {
    if (editor) {
        document.getElementById('content').value = editor.getData();
    }
}

function addVariable() {
    const container = document.getElementById('variablesContainer');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <input type="text" class="form-control" placeholder="Variable name (e.g., CLIENT_NAME)" 
               name="variable_names[]">
        <input type="text" class="form-control" placeholder="Description" 
               name="variable_descriptions[]">
        <button type="button" class="btn btn-outline-danger" onclick="removeVariable(this)">
            <i class="fas fa-minus"></i>
        </button>
    `;
    container.appendChild(div);
}

function removeVariable(button) {
    button.closest('.input-group').remove();
}

function insertPlaceholder(placeholder) {
    if (editor) {
        const selection = editor.model.document.selection;
        const position = selection.getFirstPosition();
        
        editor.model.change(writer => {
            writer.insertText(placeholder, position);
        });
        
        updateStats();
    }
}

function insertSignatureBlock() {
    const signatureBlock = `
        <table style="width: 100%; margin-top: 50px;">
            <tr>
                <td style="width: 50%; border-bottom: 1px solid black; padding-bottom: 5px;">
                    [CLIENT_NAME] Signature
                </td>
                <td style="width: 50%; border-bottom: 1px solid black; padding-bottom: 5px;">
                    Date
                </td>
            </tr>
            <tr>
                <td style="padding-top: 20px; border-bottom: 1px solid black; padding-bottom: 5px;">
                    [COMPANY_NAME] Signature
                </td>
                <td style="padding-top: 20px; border-bottom: 1px solid black; padding-bottom: 5px;">
                    Date
                </td>
            </tr>
        </table>
    `;
    
    if (editor) {
        const currentContent = editor.getData();
        editor.setData(currentContent + signatureBlock);
        updateStats();
    }
}

function loadSample(sampleType) {
    const samples = {
        'service_agreement': {
            name: 'Service Agreement Template',
            category: 'contract',
            description: 'Standard service agreement between client and service provider',
            content: `
                <h2 style="text-align: center;">SERVICE AGREEMENT</h2>
                
                <p>This Service Agreement ("Agreement") is entered into on [DATE] between:</p>
                
                <p><strong>Client:</strong> [CLIENT_NAME]<br>
                Address: [CLIENT_ADDRESS]<br>
                Email: [CLIENT_EMAIL]</p>
                
                <p><strong>Service Provider:</strong> [COMPANY_NAME]<br>
                Address: [COMPANY_ADDRESS]<br>
                Email: [COMPANY_EMAIL]</p>
                
                <h3>1. Services</h3>
                <p>The Service Provider agrees to provide the following services: [SERVICES_DESCRIPTION]</p>
                
                <h3>2. Payment Terms</h3>
                <p>Total amount: [TOTAL_AMOUNT]<br>
                Payment schedule: [PAYMENT_SCHEDULE]</p>
                
                <h3>3. Term</h3>
                <p>This agreement shall commence on [START_DATE] and terminate on [END_DATE].</p>
            `
        },
        'nda': {
            name: 'Non-Disclosure Agreement',
            category: 'legal',
            description: 'Standard NDA for protecting confidential information',
            content: `
                <h2 style="text-align: center;">NON-DISCLOSURE AGREEMENT</h2>
                
                <p>This Non-Disclosure Agreement ("Agreement") is entered into on [DATE] between [COMPANY_NAME] and [RECIPIENT_NAME].</p>
                
                <h3>1. Confidential Information</h3>
                <p>For purposes of this Agreement, "Confidential Information" shall include all information or material that has or could have commercial value...</p>
                
                <h3>2. Non-Disclosure</h3>
                <p>The Recipient agrees not to disclose any Confidential Information to third parties...</p>
            `
        },
        'business_letter': {
            name: 'Business Letter Template',
            category: 'letter',
            description: 'Professional business letter format',
            content: `
                <div style="text-align: right; margin-bottom: 30px;">
                    [DATE]
                </div>
                
                <div style="margin-bottom: 30px;">
                    [RECIPIENT_NAME]<br>
                    [RECIPIENT_TITLE]<br>
                    [RECIPIENT_COMPANY]<br>
                    [RECIPIENT_ADDRESS]
                </div>
                
                <p>Dear [RECIPIENT_NAME],</p>
                
                <p>[LETTER_BODY]</p>
                
                <p>Sincerely,</p>
                
                <div style="margin-top: 50px;">
                    [SENDER_NAME]<br>
                    [SENDER_TITLE]<br>
                    [COMPANY_NAME]
                </div>
            `
        },
        'invoice': {
            name: 'Invoice Template',
            category: 'business',
            description: 'Professional invoice template',
            content: `
                <h1 style="text-align: center; color: #333;">INVOICE</h1>
                
                <div style="margin-bottom: 30px;">
                    <strong>Invoice #:</strong> [INVOICE_NUMBER]<br>
                    <strong>Date:</strong> [INVOICE_DATE]<br>
                    <strong>Due Date:</strong> [DUE_DATE]
                </div>
                
                <div style="margin-bottom: 30px;">
                    <strong>Bill To:</strong><br>
                    [CLIENT_NAME]<br>
                    [CLIENT_ADDRESS]
                </div>
                
                <table style="width: 100%; border-collapse: collapse;">
                    <tr style="background-color: #f5f5f5;">
                        <th style="border: 1px solid #ddd; padding: 8px;">Description</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Quantity</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Rate</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">[SERVICE_DESCRIPTION]</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">[QUANTITY]</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">[RATE]</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">[AMOUNT]</td>
                    </tr>
                </table>
                
                <div style="text-align: right; margin-top: 20px;">
                    <strong>Total: [TOTAL_AMOUNT]</strong>
                </div>
            `
        }
    };
    
    const sample = samples[sampleType];
    if (sample && confirm('Load this sample template? Current content will be replaced.')) {
        document.getElementById('name').value = sample.name;
        document.getElementById('category').value = sample.category;
        document.getElementById('description').value = sample.description;
        
        if (editor) {
            editor.setData(sample.content);
            updateStats();
        }
    }
}

function testTemplate() {
    if (!editor) return;
    
    const content = editor.getData();
    const variables = content.match(/\[[\w_]+\]/g) || [];
    const uniqueVariables = [...new Set(variables)];
    
    // Populate test form
    const testVariables = document.getElementById('testVariables');
    testVariables.innerHTML = '';
    
    uniqueVariables.forEach(variable => {
        const cleanVar = variable.replace(/[\[\]]/g, '');
        const div = document.createElement('div');
        div.className = 'mb-3';
        div.innerHTML = `
            <label class="form-label">${cleanVar}:</label>
            <input type="text" class="form-control test-variable" 
                   data-variable="${variable}" 
                   placeholder="Enter value for ${cleanVar}">
        `;
        testVariables.appendChild(div);
    });
    
    // Update preview on input
    testVariables.addEventListener('input', updateTestPreview);
    
    // Initial preview
    updateTestPreview();
    
    new bootstrap.Modal(document.getElementById('testModal')).show();
}

function updateTestPreview() {
    const content = editor ? editor.getData() : '';
    let preview = content;
    
    // Replace variables with test values
    document.querySelectorAll('.test-variable').forEach(input => {
        const variable = input.dataset.variable;
        const value = input.value || `<span style="background: yellow;">${variable}</span>`;
        preview = preview.replace(new RegExp(escapeRegExp(variable), 'g'), value);
    });
    
    document.getElementById('testPreview').innerHTML = preview;
}

function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function createDocumentFromTest() {
    // Implementation would create a new document with the test values
    alert('This would create a new document with the test values.');
}

// Form submission
document.getElementById('templateForm').addEventListener('submit', function(e) {
    updateHiddenTextarea();
    
    // Validate required fields
    if (!document.getElementById('name').value.trim()) {
        e.preventDefault();
        alert('Please enter a template name.');
        return false;
    }
    
    if (!document.getElementById('category').value) {
        e.preventDefault();
        alert('Please select a category.');
        return false;
    }
    
    if (!editor || !editor.getData().trim()) {
        e.preventDefault();
        alert('Please enter template content.');
        return false;
    }
});

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}