{% extends 'base.html' %}
{% load static %}

{% block title %}{{ template.name }} - Document Editor{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'document_editor/css/document-editor.css' %}">
<style>
.template-preview {
    background: white;
    border: 1px solid #ddd;
    padding: 30px;
    font-family: 'Times New Roman', serif;
    min-height: 400px;
}
.variable-highlight {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    padding: 2px 4px;
    border-radius: 3px;
    cursor: pointer;
}
.version-badge {
    position: absolute;
    top: 10px;
    right: 10px;
}
.usage-stats {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
}
.action-card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}
.action-card:hover {
    transform: translateY(-2px);
}
.rating-stars {
    color: #ffc107;
}
.comment-thread {
    border-left: 3px solid #007bff;
    padding-left: 15px;
    margin-bottom: 20px;
}
.share-link {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 10px;
    font-family: monospace;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'document_editor:dashboard' %}">Document Editor</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'document_editor:template_list' %}">Templates</a></li>
                            <li class="breadcrumb-item active">{{ template.name }}</li>
                        </ol>
                    </nav>
                    <div class="d-flex align-items-center">
                        <h1 class="h3 mb-0 me-3">ðŸ“„ {{ template.name }}</h1>
                        <span class="badge bg-{% if template.access_level == 'public' %}success{% elif template.access_level == 'team' %}info{% else %}secondary{% endif %}">
                            {{ template.get_access_level_display }}
                        </span>
                        {% if template.is_featured %}
                            <span class="badge bg-warning ms-2">Featured</span>
                        {% endif %}
                    </div>
                    {% if template.description %}
                        <p class="text-muted mb-0 mt-2">{{ template.description }}</p>
                    {% endif %}
                </div>
                <div>
                    <a href="{% url 'document_editor:template_list' %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left"></i> Back to Templates
                    </a>
                    {% if template.created_by == request.user or request.user.is_staff %}
                    <a href="{% url 'document_editor:template_edit' template.id %}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    {% endif %}
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-plus"></i> Use Template
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{% url 'document_editor:document_create' %}?template={{ template.id }}">
                                <i class="fas fa-file-plus"></i> Create Document
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="useWithVariables()">
                                <i class="fas fa-magic"></i> Fill Variables
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="downloadTemplate()">
                                <i class="fas fa-download"></i> Download
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8 mb-4">
            <!-- Template Preview -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Template Preview</h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleVariableHighlights()">
                            <i class="fas fa-highlighter"></i> Highlight Variables
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="printPreview()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="template-preview" id="templatePreview">
                        {{ template.content|safe }}
                    </div>
                </div>
            </div>

            <!-- Variables -->
            {% if template.variables.exists %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Template Variables</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for variable in template.variables.all %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">{{ variable.name }}</h6>
                                    <p class="card-text text-muted">{{ variable.description|default:"No description" }}</p>
                                    <small class="text-muted">Type: {{ variable.variable_type|default:"Text" }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Version History -->
            {% if template.versions.exists %}
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Version History</h5>
                    <span class="badge bg-info">{{ template.versions.count }} version{{ template.versions.count|pluralize }}</span>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for version in template.versions.all|slice:":5" %}
                        <div class="list-group-item d-flex justify-content-between align-items-start">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">Version {{ version.version_number }}</div>
                                <p class="mb-1">{{ version.change_description|default:"No description provided" }}</p>
                                <small class="text-muted">{{ version.created_at|timesince }} ago by {{ version.created_by.get_full_name }}</small>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="viewVersion({{ version.id }})" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="compareVersion({{ version.id }})" title="Compare">
                                    <i class="fas fa-balance-scale"></i>
                                </button>
                                {% if template.created_by == request.user or request.user.is_staff %}
                                <button type="button" class="btn btn-outline-warning" onclick="restoreVersion({{ version.id }})" title="Restore">
                                    <i class="fas fa-undo"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if template.versions.count > 5 %}
                    <div class="text-center mt-3">
                        <a href="{% url 'document_editor:template_versions' template.id %}" class="btn btn-outline-primary">
                            View All Versions ({{ template.versions.count }})
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Comments and Reviews -->
            {% if template.allow_comments %}
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Comments & Reviews</h5>
                    <button type="button" class="btn btn-sm btn-primary" onclick="addComment()">
                        <i class="fas fa-comment"></i> Add Comment
                    </button>
                </div>
                <div class="card-body">
                    {% for comment in template.comments.all|slice:":10" %}
                    <div class="comment-thread">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ comment.user.get_full_name }}</strong>
                                {% if comment.rating %}
                                <div class="rating-stars">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= comment.rating %}
                                            <i class="fas fa-star"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <p class="mt-2">{{ comment.content }}</p>
                            </div>
                            <small class="text-muted">{{ comment.created_at|timesince }} ago</small>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center">No comments yet. Be the first to leave feedback!</p>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4 mb-4">
            <!-- Usage Statistics -->
            <div class="card action-card mb-4">
                <div class="card-body usage-stats text-center">
                    <h5 class="card-title">Usage Statistics</h5>
                    <div class="row">
                        <div class="col-6">
                            <h3>{{ template.usage_count|default:0 }}</h3>
                            <small>Times Used</small>
                        </div>
                        <div class="col-6">
                            <h3>{{ template.rating|default:0|floatformat:1 }}/5</h3>
                            <small>Average Rating</small>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-6">
                            <h4>{{ template.downloads|default:0 }}</h4>
                            <small>Downloads</small>
                        </div>
                        <div class="col-6">
                            <h4>{{ template.favorites_count|default:0 }}</h4>
                            <small>Favorites</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card action-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'document_editor:document_create' %}?template={{ template.id }}" class="btn btn-primary">
                            <i class="fas fa-file-plus"></i> Create Document
                        </a>
                        <button type="button" class="btn btn-outline-primary" onclick="duplicateTemplate()">
                            <i class="fas fa-copy"></i> Duplicate Template
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="favoriteTemplate()">
                            <i class="fas fa-heart"></i> Add to Favorites
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="shareTemplate()">
                            <i class="fas fa-share-alt"></i> Share Template
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="reportTemplate()">
                            <i class="fas fa-flag"></i> Report Issue
                        </button>
                    </div>
                </div>
            </div>

            <!-- Template Information -->
            <div class="card action-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Template Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Category:</strong></td>
                            <td>{{ template.get_category_display }}</td>
                        </tr>
                        <tr>
                            <td><strong>Language:</strong></td>
                            <td>{{ template.get_language_display }}</td>
                        </tr>
                        <tr>
                            <td><strong>Created:</strong></td>
                            <td>{{ template.created_at|date:"M j, Y" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Author:</strong></td>
                            <td>{{ template.created_by.get_full_name }}</td>
                        </tr>
                        <tr>
                            <td><strong>Last Modified:</strong></td>
                            <td>{{ template.updated_at|date:"M j, Y" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Version:</strong></td>
                            <td>{{ template.current_version|default:1 }}</td>
                        </tr>
                        <tr>
                            <td><strong>Word Count:</strong></td>
                            <td>{{ template.word_count|default:0 }}</td>
                        </tr>
                        <tr>
                            <td><strong>Variables:</strong></td>
                            <td>{{ template.variables.count }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Tags -->
            {% if template.tags.exists %}
            <div class="card action-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Tags</h5>
                </div>
                <div class="card-body">
                    {% for tag in template.tags.all %}
                        <span class="badge bg-secondary me-1 mb-1">{{ tag.name }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Related Templates -->
            {% if related_templates %}
            <div class="card action-card">
                <div class="card-header">
                    <h5 class="mb-0">Related Templates</h5>
                </div>
                <div class="card-body">
                    {% for related in related_templates %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <a href="{% url 'document_editor:template_detail' related.id %}" class="text-decoration-none">
                                <strong>{{ related.name|truncatechars:25 }}</strong>
                            </a>
                            <br><small class="text-muted">{{ related.category|title }}</small>
                        </div>
                        <div class="text-end">
                            <div class="rating-stars">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= related.rating %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <small class="text-muted">{{ related.usage_count }} uses</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Use Template with Variables Modal -->
<div class="modal fade" id="useTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Use Template: {{ template.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="useTemplateForm">
                <div class="modal-body">
                    <div id="variableInputs">
                        {% for variable in template.variables.all %}
                        <div class="mb-3">
                            <label for="var_{{ variable.id }}" class="form-label">
                                {{ variable.name }}
                                {% if variable.description %}
                                    <i class="fas fa-info-circle" title="{{ variable.description }}"></i>
                                {% endif %}
                            </label>
                            {% if variable.variable_type == 'text' %}
                                <input type="text" class="form-control" id="var_{{ variable.id }}" name="{{ variable.name }}" placeholder="Enter {{ variable.name|lower }}">
                            {% elif variable.variable_type == 'textarea' %}
                                <textarea class="form-control" id="var_{{ variable.id }}" name="{{ variable.name }}" rows="3" placeholder="Enter {{ variable.name|lower }}"></textarea>
                            {% elif variable.variable_type == 'date' %}
                                <input type="date" class="form-control" id="var_{{ variable.id }}" name="{{ variable.name }}">
                            {% elif variable.variable_type == 'number' %}
                                <input type="number" class="form-control" id="var_{{ variable.id }}" name="{{ variable.name }}" placeholder="Enter {{ variable.name|lower }}">
                            {% else %}
                                <input type="text" class="form-control" id="var_{{ variable.id }}" name="{{ variable.name }}" placeholder="Enter {{ variable.name|lower }}">
                            {% endif %}
                            {% if variable.description %}
                                <small class="form-text text-muted">{{ variable.description }}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Document</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Share Template Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="shareLink" class="form-label">Share Link:</label>
                    <div class="share-link" id="shareLink">
                        {{ request.build_absolute_uri }}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="copyShareLink()">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Share via:</label>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-primary" onclick="shareViaEmail()">
                            <i class="fas fa-envelope"></i> Email
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="shareViaSlack()">
                            <i class="fab fa-slack"></i> Slack
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="shareViaWhatsApp()">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Comment Modal -->
<div class="modal fade" id="commentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Comment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="commentForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="commentRating" class="form-label">Rating (Optional)</label>
                        <select class="form-control" id="commentRating" name="rating">
                            <option value="">No Rating</option>
                            <option value="1">1 Star</option>
                            <option value="2">2 Stars</option>
                            <option value="3">3 Stars</option>
                            <option value="4">4 Stars</option>
                            <option value="5">5 Stars</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="commentContent" class="form-label">Comment</label>
                        <textarea class="form-control" id="commentContent" name="content" rows="4" required placeholder="Share your thoughts about this template..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Comment</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let variableHighlightsVisible = false;

function toggleVariableHighlights() {
    const preview = document.getElementById('templatePreview');
    
    if (!variableHighlightsVisible) {
        // Add highlights
        let content = preview.innerHTML;
        content = content.replace(/\[([A-Z_]+)\]/g, '<span class="variable-highlight" title="Variable: $1">[$1]</span>');
        preview.innerHTML = content;
        variableHighlightsVisible = true;
    } else {
        // Remove highlights
        const highlights = preview.querySelectorAll('.variable-highlight');
        highlights.forEach(highlight => {
            highlight.outerHTML = highlight.innerHTML;
        });
        variableHighlightsVisible = false;
    }
}

function printPreview() {
    const preview = document.getElementById('templatePreview').innerHTML;
    const printWindow = window.open('', '', 'height=600,width=800');
    
    printWindow.document.write(`
        <html>
        <head>
            <title>{{ template.name }} - Preview</title>
            <style>
                body { font-family: 'Times New Roman', serif; padding: 20px; }
                .variable-highlight { background: none; border: none; }
            </style>
        </head>
        <body>
            ${preview}
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}

function useWithVariables() {
    new bootstrap.Modal(document.getElementById('useTemplateModal')).show();
}

function downloadTemplate() {
    window.open(`/document-editor/templates/{{ template.id }}/download/`, '_blank');
}

function duplicateTemplate() {
    if (confirm('Create a copy of this template?')) {
        fetch(`/document-editor/api/templates/{{ template.id }}/duplicate/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = `/document-editor/templates/${data.template_id}/`;
            } else {
                alert('Error duplicating template: ' + data.error);
            }
        });
    }
}

function favoriteTemplate() {
    fetch(`/document-editor/api/templates/{{ template.id }}/favorite/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.favorited ? 'Template added to favorites!' : 'Template removed from favorites!');
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function shareTemplate() {
    new bootstrap.Modal(document.getElementById('shareModal')).show();
}

function copyShareLink() {
    const link = document.getElementById('shareLink').textContent;
    navigator.clipboard.writeText(link).then(() => {
        alert('Link copied to clipboard!');
    });
}

function shareViaEmail() {
    const subject = encodeURIComponent(`Check out this template: {{ template.name }}`);
    const body = encodeURIComponent(`I found this useful template and thought you might like it:\n\n{{ template.name }}\n{{ request.build_absolute_uri }}`);
    window.open(`mailto:?subject=${subject}&body=${body}`);
}

function shareViaSlack() {
    const text = encodeURIComponent(`Check out this template: {{ template.name }} - {{ request.build_absolute_uri }}`);
    window.open(`https://slack.com/intl/en-gb/share?url=${text}`);
}

function shareViaWhatsApp() {
    const text = encodeURIComponent(`Check out this template: {{ template.name }} - {{ request.build_absolute_uri }}`);
    window.open(`https://wa.me/?text=${text}`);
}

function addComment() {
    new bootstrap.Modal(document.getElementById('commentModal')).show();
}

function reportTemplate() {
    const reason = prompt('Please describe the issue with this template:');
    if (reason) {
        fetch(`/document-editor/api/templates/{{ template.id }}/report/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ reason: reason })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Report submitted successfully. Thank you for your feedback!');
            } else {
                alert('Error submitting report: ' + data.error);
            }
        });
    }
}

function viewVersion(versionId) {
    fetch(`/document-editor/api/template-versions/${versionId}/`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const newWindow = window.open('', '', 'height=600,width=800');
            newWindow.document.write(`
                <html>
                <head>
                    <title>Version ${data.version.version_number} - {{ template.name }}</title>
                    <style>body { font-family: Arial, sans-serif; padding: 20px; }</style>
                </head>
                <body>
                    <h2>Version ${data.version.version_number}</h2>
                    <p><strong>Created:</strong> ${new Date(data.version.created_at).toLocaleDateString()}</p>
                    <p><strong>Author:</strong> ${data.version.created_by_name}</p>
                    <hr>
                    ${data.version.content}
                </body>
                </html>
            `);
        }
    });
}

function compareVersion(versionId) {
    alert('Version comparison feature will be implemented');
}

function restoreVersion(versionId) {
    if (confirm('Restore this version? Current changes will be saved as a new version.')) {
        fetch(`/document-editor/api/template-versions/${versionId}/restore/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error restoring version: ' + data.error);
            }
        });
    }
}

// Form submissions
document.getElementById('useTemplateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const variables = {};
    
    for (let [key, value] of formData.entries()) {
        variables[key] = value;
    }
    
    const params = new URLSearchParams({
        template_id: {{ template.id }},
        variables: JSON.stringify(variables)
    });
    
    window.location.href = `/document-editor/documents/create/?${params.toString()}`;
});

document.getElementById('commentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const commentData = {
        content: formData.get('content'),
        rating: formData.get('rating') ? parseInt(formData.get('rating')) : null
    };
    
    fetch(`/document-editor/api/templates/{{ template.id }}/comment/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(commentData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('commentModal')).hide();
            location.reload();
        } else {
            alert('Error adding comment: ' + data.error);
        }
    });
});

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}