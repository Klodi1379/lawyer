{% extends 'base.html' %}
{% load static %}

{% block title %}My Invoices - Client Portal{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'client_portal:dashboard' %}">Portal</a></li>
                            <li class="breadcrumb-item active">Invoices</li>
                        </ol>
                    </nav>
                    <h1 class="h3 mb-0">ðŸ’° My Invoices</h1>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">${{ total_amount|default:0|floatformat:2 }}</h4>
                            <p class="card-text">Total Invoiced</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-file-invoice fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">${{ paid_amount|default:0|floatformat:2 }}</h4>
                            <p class="card-text">Paid</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">${{ outstanding_amount|default:0|floatformat:2 }}</h4>
                            <p class="card-text">Outstanding</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ overdue_count|default:0 }}</h4>
                            <p class="card-text">Overdue</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter and Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-4">
                            <input type="text" name="search" class="form-control" placeholder="Search invoices..." value="{{ request.GET.search }}">
                        </div>
                        <div class="col-md-3">
                            <select name="status" class="form-control">
                                <option value="">All Status</option>
                                <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="paid" {% if request.GET.status == 'paid' %}selected{% endif %}>Paid</option>
                                <option value="overdue" {% if request.GET.status == 'overdue' %}selected{% endif %}>Overdue</option>
                                <option value="cancelled" {% if request.GET.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select name="year" class="form-control">
                                <option value="">All Years</option>
                                {% for year in available_years %}
                                <option value="{{ year }}" {% if request.GET.year == year|stringformat:'s' %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoices List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        Invoices 
                        <span class="badge bg-secondary">{{ invoices.count|default:0 }}</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if invoices %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Date</th>
                                        <th>Case</th>
                                        <th>Amount</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for invoice in invoices %}
                                    <tr>
                                        <td>
                                            <strong>{{ invoice.invoice_number }}</strong>
                                            {% if invoice.description %}
                                                <br><small class="text-muted">{{ invoice.description|truncatechars:30 }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span>{{ invoice.issue_date|date:"M j, Y" }}</span>
                                        </td>
                                        <td>
                                            {% if invoice.case %}
                                                <a href="{% url 'client_portal:case_detail' invoice.case.id %}" class="text-decoration-none">
                                                    {{ invoice.case.title|truncatechars:25 }}
                                                </a>
                                            {% else %}
                                                <span class="text-muted">General</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <strong>${{ invoice.total_amount|floatformat:2 }}</strong>
                                            {% if invoice.currency and invoice.currency.code != 'USD' %}
                                                <br><small class="text-muted">{{ invoice.currency.code }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span>{{ invoice.due_date|date:"M j, Y" }}</span>
                                            {% if invoice.is_overdue %}
                                                <br><small class="text-danger">{{ invoice.days_overdue }} days overdue</small>
                                            {% else %}
                                                <br><small class="text-muted">{{ invoice.days_until_due }} days left</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if invoice.status == 'paid' %}
                                                <span class="badge bg-success">Paid</span>
                                            {% elif invoice.status == 'overdue' %}
                                                <span class="badge bg-danger">Overdue</span>
                                            {% elif invoice.status == 'pending' %}
                                                <span class="badge bg-warning">Pending</span>
                                            {% elif invoice.status == 'cancelled' %}
                                                <span class="badge bg-secondary">Cancelled</span>
                                            {% else %}
                                                <span class="badge bg-info">{{ invoice.get_status_display }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary" onclick="viewInvoice({{ invoice.id }})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <a href="/billing/invoices/{{ invoice.id }}/pdf/" class="btn btn-outline-secondary" target="_blank">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                {% if invoice.status != 'paid' and invoice.status != 'cancelled' %}
                                                <button type="button" class="btn btn-outline-success" onclick="payInvoice({{ invoice.id }})">
                                                    <i class="fas fa-credit-card"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-file-invoice fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">No Invoices Found</h5>
                            <p class="text-muted">
                                {% if request.GET.search or request.GET.status or request.GET.year %}
                                    No invoices match your current filters. 
                                    <a href="{% url 'client_portal:invoices' %}">Clear filters</a>
                                {% else %}
                                    You don't have any invoices yet.
                                {% endif %}
                            </p>
                        </div>
                    {% endif %}
                </div>

                <!-- Pagination -->
                {% if invoices.has_other_pages %}
                <div class="card-footer">
                    <nav aria-label="Invoices pagination">
                        <ul class="pagination justify-content-center mb-0">
                            {% if invoices.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ invoices.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.year %}&year={{ request.GET.year }}{% endif %}">Previous</a>
                                </li>
                            {% endif %}

                            {% for num in invoices.paginator.page_range %}
                                {% if invoices.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > invoices.number|add:'-3' and num < invoices.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.year %}&year={{ request.GET.year }}{% endif %}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if invoices.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ invoices.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.year %}&year={{ request.GET.year }}{% endif %}">Next</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Payment History -->
    {% if recent_payments %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Recent Payments</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Invoice</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in recent_payments %}
                                <tr>
                                    <td>{{ payment.payment_date|date:"M j, Y" }}</td>
                                    <td>
                                        <a href="#" onclick="viewInvoice({{ payment.invoice.id }})">
                                            {{ payment.invoice.invoice_number }}
                                        </a>
                                    </td>
                                    <td>${{ payment.amount|floatformat:2 }}</td>
                                    <td>{{ payment.get_payment_method_display }}</td>
                                    <td>
                                        <span class="badge bg-success">Completed</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <a href="{% url 'client_portal:payments' %}" class="btn btn-sm btn-outline-primary">
                            View All Payments
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Invoice Detail Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Invoice Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invoiceContent">
                <!-- Invoice content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="payInvoiceBtn" style="display: none;">
                    <i class="fas fa-credit-card"></i> Pay Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pay Invoice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="paymentForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Invoice Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="text" class="form-control" id="paymentAmount" readonly>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Payment Method</label>
                        <select class="form-control" id="paymentMethod" required>
                            <option value="">Select payment method</option>
                            <option value="credit_card">Credit Card</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="paypal">PayPal</option>
                            <option value="check">Check</option>
                        </select>
                    </div>
                    <div id="creditCardForm" style="display: none;">
                        <div class="mb-3">
                            <label for="cardNumber" class="form-label">Card Number</label>
                            <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456">
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <label for="expiryDate" class="form-label">Expiry Date</label>
                                <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY">
                            </div>
                            <div class="col-6">
                                <label for="cvv" class="form-label">CVV</label>
                                <input type="text" class="form-control" id="cvv" placeholder="123">
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="savePaymentMethod">
                            <label class="form-check-label" for="savePaymentMethod">
                                Save payment method for future use
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-credit-card"></i> Pay Now
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentInvoiceId = null;

function viewInvoice(invoiceId) {
    fetch(`/client-portal/api/invoices/${invoiceId}/`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('invoiceContent').innerHTML = data.html;
            
            // Show pay button if invoice is not paid
            if (data.invoice.status !== 'paid' && data.invoice.status !== 'cancelled') {
                document.getElementById('payInvoiceBtn').style.display = 'block';
                document.getElementById('payInvoiceBtn').onclick = () => payInvoice(invoiceId);
            } else {
                document.getElementById('payInvoiceBtn').style.display = 'none';
            }
            
            new bootstrap.Modal(document.getElementById('invoiceModal')).show();
        } else {
            alert('Error loading invoice: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error loading invoice: ' + error);
    });
}

function payInvoice(invoiceId) {
    currentInvoiceId = invoiceId;
    
    // Load invoice amount
    fetch(`/client-portal/api/invoices/${invoiceId}/`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('paymentAmount').value = data.invoice.total_amount;
            new bootstrap.Modal(document.getElementById('paymentModal')).show();
        }
    });
}

// Payment method change handler
document.getElementById('paymentMethod').addEventListener('change', function() {
    const creditCardForm = document.getElementById('creditCardForm');
    if (this.value === 'credit_card') {
        creditCardForm.style.display = 'block';
    } else {
        creditCardForm.style.display = 'none';
    }
});

// Payment form submission
document.getElementById('paymentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const paymentData = {
        invoice_id: currentInvoiceId,
        amount: document.getElementById('paymentAmount').value,
        payment_method: document.getElementById('paymentMethod').value,
        save_method: document.getElementById('savePaymentMethod').checked
    };
    
    // Add credit card data if applicable
    if (paymentData.payment_method === 'credit_card') {
        paymentData.card_number = document.getElementById('cardNumber').value;
        paymentData.expiry_date = document.getElementById('expiryDate').value;
        paymentData.cvv = document.getElementById('cvv').value;
    }
    
    fetch('/client-portal/api/process-payment/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(paymentData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Payment processed successfully!');
            bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
            location.reload();
        } else {
            alert('Payment failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('Payment failed: ' + error);
    });
});

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Format card number input
document.getElementById('cardNumber').addEventListener('input', function() {
    let value = this.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
    let formattedValue = value.match(/\d{4,16}/g)?.join(' ');
    this.value = formattedValue || value;
});

// Format expiry date input
document.getElementById('expiryDate').addEventListener('input', function() {
    let value = this.value.replace(/\D/g, '');
    if (value.length >= 2) {
        this.value = value.substring(0, 2) + '/' + value.substring(2, 4);
    } else {
        this.value = value;
    }
});
</script>
{% endblock %}