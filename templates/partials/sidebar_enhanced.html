{% load static %}

<!-- Enhanced Sidebar me veçoritë e reja -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="d-flex align-items-center">
            <i class="bi bi-briefcase me-2 fs-4 text-primary"></i>
            <div>
                <h6 class="mb-0 fw-bold">Legal Manager</h6>
                <small class="text-muted d-none d-md-block">Enhanced Case Management</small>
            </div>
        </div>
        
        <!-- Close button for mobile -->
        <button class="btn btn-link d-lg-none p-0 ms-auto" id="sidebarClose">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>

    <div class="sidebar-content">
        {% if user.is_authenticated %}
            <!-- User Info -->
            <div class="user-info mb-3">
                <div class="d-flex align-items-center">
                    {% if user.profile.profile_picture %}
                        <img src="{{ user.profile.profile_picture.url }}" alt="Profile" class="rounded-circle me-2" style="width: 32px; height: 32px;">
                    {% else %}
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                            <i class="bi bi-person text-white"></i>
                        </div>
                    {% endif %}
                    <div class="flex-grow-1">
                        <div class="fw-semibold small">{{ user.get_full_name|default:user.username }}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">
                            <span class="badge bg-{{ user.role|default:'secondary' }}-subtle text-{{ user.role|default:'secondary' }}">
                                {{ user.get_role_display }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Enhanced -->
            <div class="quick-actions mb-3">
                <div class="text-muted small mb-2 fw-semibold">QUICK ACTIONS</div>
                <div class="btn-group-vertical w-100" role="group">
                    {% if user.role in 'admin,lawyer' %}
                    <a href="{% url 'case_create' %}" class="btn btn-primary btn-sm mb-1" data-bs-toggle="tooltip" title="Create New Case">
                        <i class="bi bi-plus-circle me-2"></i>New Case
                    </a>
                    <a href="#" onclick="generateInvoice()" class="btn btn-success btn-sm mb-1" data-bs-toggle="tooltip" title="Generate Invoice">
                        <i class="bi bi-receipt me-2"></i>New Invoice
                    </a>
                    {% endif %}
                    
                    {% if user.role in 'admin,lawyer,paralegal' %}
                    <a href="{% url 'document_upload' %}" class="btn btn-outline-primary btn-sm mb-1" data-bs-toggle="tooltip" title="Upload Document">
                        <i class="bi bi-cloud-upload me-2"></i>Upload Doc
                    </a>
                    <a href="{% url 'event_create' %}" class="btn btn-outline-primary btn-sm" data-bs-toggle="tooltip" title="Create Event">
                        <i class="bi bi-calendar-plus me-2"></i>New Event
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Main Navigation Enhanced -->
            <nav class="sidebar-nav">
                <ul class="nav flex-column">
                    <!-- Dashboard -->
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" href="{% url 'dashboard' %}">
                            <i class="bi bi-speedometer2 nav-icon"></i>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    </li>

                    <!-- Cases Section -->
                    <li class="nav-item">
                        <div class="nav-section-header">
                            <span class="text-muted small fw-semibold">CASE MANAGEMENT</span>
                        </div>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link {% if 'case' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#casesCollapse" 
                           data-bs-toggle="collapse" 
                           role="button"
                           aria-expanded="{% if 'case' in request.resolver_match.url_name %}true{% else %}false{% endif %}">
                            <i class="bi bi-folder nav-icon"></i>
                            <span class="nav-text">Cases</span>
                            <i class="bi bi-chevron-down ms-auto collapse-icon"></i>
                        </a>
                        <div class="collapse {% if 'case' in request.resolver_match.url_name %}show{% endif %}" id="casesCollapse">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link {% if request.resolver_match.url_name == 'case_list' %}active{% endif %}" href="{% url 'case_list' %}">
                                        <i class="bi bi-list-ul nav-icon"></i>
                                        <span class="nav-text">All Cases</span>
                                        <span class="badge bg-primary ms-auto" id="total-cases-count">{{ user.get_assigned_cases_count }}</span>
                                    </a>
                                </li>
                                {% if user.role in 'admin,lawyer' %}
                                <li class="nav-item">
                                    <a class="nav-link {% if request.resolver_match.url_name == 'case_create' %}active{% endif %}" href="{% url 'case_create' %}">
                                        <i class="bi bi-plus-circle nav-icon"></i>
                                        <span class="nav-text">New Case</span>
                                    </a>
                                </li>
                                {% endif %}
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'case_list' %}?status=open">
                                        <i class="bi bi-folder-check nav-icon"></i>
                                        <span class="nav-text">Open Cases</span>
                                        <span class="badge bg-success ms-auto" id="open-cases-count">{{ user.get_open_cases_count }}</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'case_list' %}?status=in_court">
                                        <i class="bi bi-building nav-icon"></i>
                                        <span class="nav-text">In Court</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'case_list' %}?status=closed">
                                        <i class="bi bi-folder-x nav-icon"></i>
                                        <span class="nav-text">Closed Cases</span>
                                        <span class="badge bg-secondary ms-auto" id="closed-cases-count">{{ user.get_closed_cases_count }}</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </li>

                    <!-- Clients Section -->
                    {% if user.role in 'admin,lawyer,paralegal' %}
                    <li class="nav-item">
                        <a class="nav-link {% if 'client' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#clientsCollapse" 
                           data-bs-toggle="collapse" 
                           role="button"
                           aria-expanded="{% if 'client' in request.resolver_match.url_name %}true{% else %}false{% endif %}">
                            <i class="bi bi-people nav-icon"></i>
                            <span class="nav-text">Clients</span>
                            <i class="bi bi-chevron-down ms-auto collapse-icon"></i>
                        </a>
                        <div class="collapse {% if 'client' in request.resolver_match.url_name %}show{% endif %}" id="clientsCollapse">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link {% if request.resolver_match.url_name == 'client_list' %}active{% endif %}" href="{% url 'client_list' %}">
                                        <i class="bi bi-person-lines-fill nav-icon"></i>
                                        <span class="nav-text">All Clients</span>
                                    </a>
                                </li>
                                {% if user.role in 'admin,lawyer' %}
                                <li class="nav-item">
                                    <a class="nav-link {% if request.resolver_match.url_name == 'client_create' %}active{% endif %}" href="{% url 'client_create' %}">
                                        <i class="bi bi-person-plus nav-icon"></i>
                                        <span class="nav-text">New Client</span>
                                    </a>
                                </li>
                                {% endif %}
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'client_list' %}?type=individual">
                                        <i class="bi bi-person nav-icon"></i>
                                        <span class="nav-text">Individuals</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'client_list' %}?type=organization">
                                        <i class="bi bi-building nav-icon"></i>
                                        <span class="nav-text">Organizations</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    {% endif %}

                    <!-- BILLING & FINANCE SECTION - E REJA -->
                    {% if user.role in 'admin,lawyer' %}
                    <li class="nav-item">
                        <div class="nav-section-header">
                            <span class="text-muted small fw-semibold">BILLING & FINANCE</span>
                        </div>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link {% if 'billing' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#billingCollapse" 
                           data-bs-toggle="collapse" 
                           role="button"
                           aria-expanded="{% if 'billing' in request.resolver_match.url_name %}true{% else %}false{% endif %}">
                            <i class="bi bi-receipt nav-icon"></i>
                            <span class="nav-text">Billing</span>
                            <span class="badge bg-success ms-auto">NEW</span>
                            <i class="bi bi-chevron-down collapse-icon"></i>
                        </a>
                        <div class="collapse {% if 'billing' in request.resolver_match.url_name %}show{% endif %}" id="billingCollapse">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'billing_dashboard' %}">
                                        <i class="bi bi-speedometer2 nav-icon"></i>
                                        <span class="nav-text">Billing Dashboard</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'invoices_list' %}">
                                        <i class="bi bi-file-earmark-text nav-icon"></i>
                                        <span class="nav-text">Invoices</span>
                                        <span class="badge bg-warning ms-auto" id="pending-invoices-count">0</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'generate_invoice' %}">
                                        <i class="bi bi-plus-circle nav-icon"></i>
                                        <span class="nav-text">Generate Invoice</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'expenses_list' %}">
                                        <i class="bi bi-credit-card nav-icon"></i>
                                        <span class="nav-text">Expenses</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'payments_list' %}">
                                        <i class="bi bi-cash-coin nav-icon"></i>
                                        <span class="nav-text">Payments</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'billing_dashboard' %}">
                                        <i class="bi bi-clock nav-icon"></i>
                                        <span class="nav-text">Time Tracking</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    {% endif %}

                    <!-- Documents Section -->
                    <li class="nav-item">
                        <div class="nav-section-header">
                            <span class="text-muted small fw-semibold">DOCUMENTS & FILES</span>
                        </div>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link {% if 'document' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#documentsCollapse" 
                           data-bs-toggle="collapse" 
                           role="button"
                           aria-expanded="{% if 'document' in request.resolver_match.url_name %}true{% else %}false{% endif %}">
                            <i class="bi bi-file-earmark-text nav-icon"></i>
                            <span class="nav-text">Documents</span>
                            <i class="bi bi-chevron-down ms-auto collapse-icon"></i>
                        </a>
                        <div class="collapse {% if 'document' in request.resolver_match.url_name %}show{% endif %}" id="documentsCollapse">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link {% if request.resolver_match.url_name == 'document_list' %}active{% endif %}" href="{% url 'document_list' %}">
                                        <i class="bi bi-files nav-icon"></i>
                                        <span class="nav-text">All Documents</span>
                                    </a>
                                </li>
                                {% if user.role in 'admin,lawyer,paralegal' %}
                                <li class="nav-item">
                                    <a class="nav-link {% if request.resolver_match.url_name == 'document_upload' %}active{% endif %}" href="{% url 'document_upload' %}">
                                        <i class="bi bi-cloud-upload nav-icon"></i>
                                        <span class="nav-text">Upload Document</span>
                                    </a>
                                </li>
                                {% endif %}
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'document_list' %}?status=draft">
                                        <i class="bi bi-file-earmark-plus nav-icon"></i>
                                        <span class="nav-text">Draft Documents</span>
                                        <span class="badge bg-warning ms-auto" id="draft-docs-count">0</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'document_list' %}?status=signed">
                                        <i class="bi bi-file-earmark-check nav-icon"></i>
                                        <span class="nav-text">Signed Documents</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'document_editor' %}">
                                        <i class="bi bi-pencil-square nav-icon"></i>
                                        <span class="nav-text">Document Editor</span>
                                        <span class="badge bg-info ms-auto">AI</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </li>

                    <!-- Calendar & Events Section -->
                    <li class="nav-item">
                        <div class="nav-section-header">
                            <span class="text-muted small fw-semibold">CALENDAR & EVENTS</span>
                        </div>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link {% if 'event' in request.resolver_match.url_name or 'calendar' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#eventsCollapse" 
                           data-bs-toggle="collapse" 
                           role="button"
                           aria-expanded="{% if 'event' in request.resolver_match.url_name or 'calendar' in request.resolver_match.url_name %}true{% else %}false{% endif %}">
                            <i class="bi bi-calendar3 nav-icon"></i>
                            <span class="nav-text">Calendar</span>
                            <i class="bi bi-chevron-down ms-auto collapse-icon"></i>
                        </a>
                        <div class="collapse {% if 'event' in request.resolver_match.url_name or 'calendar' in request.resolver_match.url_name %}show{% endif %}" id="eventsCollapse">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link {% if request.resolver_match.url_name == 'event_calendar' %}active{% endif %}" href="{% url 'event_calendar' %}">
                                        <i class="bi bi-calendar3-event nav-icon"></i>
                                        <span class="nav-text">Calendar View</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link {% if request.resolver_match.url_name == 'event_list' %}active{% endif %}" href="{% url 'event_list' %}">
                                        <i class="bi bi-list-ul nav-icon"></i>
                                        <span class="nav-text">Events List</span>
                                    </a>
                                </li>
                                {% if user.role in 'admin,lawyer,paralegal' %}
                                <li class="nav-item">
                                    <a class="nav-link {% if request.resolver_match.url_name == 'event_create' %}active{% endif %}" href="{% url 'event_create' %}">
                                        <i class="bi bi-plus-circle nav-icon"></i>
                                        <span class="nav-text">New Event</span>
                                    </a>
                                </li>
                                {% endif %}
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'event_list' %}?deadline=true">
                                        <i class="bi bi-clock nav-icon"></i>
                                        <span class="nav-text">Deadlines</span>
                                        <span class="badge bg-danger ms-auto" id="upcoming-deadlines-count">0</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'event_list' %}?upcoming=7">
                                        <i class="bi bi-calendar2-check nav-icon"></i>
                                        <span class="nav-text">This Week</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </li>

                    <!-- ANALYTICS & REPORTING - E REJA -->
                    {% if user.role in 'admin,lawyer' %}
                    <li class="nav-item">
                        <div class="nav-section-header">
                            <span class="text-muted small fw-semibold">ANALYTICS & INSIGHTS</span>
                        </div>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link {% if 'enhanced_dashboard' in request.resolver_match.url_name %}active{% endif %}" 
                           href="#analyticsCollapse" 
                           data-bs-toggle="collapse" 
                           role="button"
                           aria-expanded="{% if 'enhanced_dashboard' in request.resolver_match.url_name %}true{% else %}false{% endif %}">
                            <i class="bi bi-graph-up nav-icon"></i>
                            <span class="nav-text">Analytics</span>
                            <span class="badge bg-info ms-auto">NEW</span>
                            <i class="bi bi-chevron-down collapse-icon"></i>
                        </a>
                        <div class="collapse {% if 'enhanced_dashboard' in request.resolver_match.url_name %}show{% endif %}" id="analyticsCollapse">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'analytics_dashboard' %}">
                                        <i class="bi bi-speedometer2 nav-icon"></i>
                                        <span class="nav-text">Analytics Dashboard</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'analytics_dashboard' %}">
                                        <i class="bi bi-currency-dollar nav-icon"></i>
                                        <span class="nav-text">Financial Analysis</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'analytics_dashboard' %}">
                                        <i class="bi bi-person-check nav-icon"></i>
                                        <span class="nav-text">Performance Metrics</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'enhanced_dashboard' %}">
                                        <i class="bi bi-trophy nav-icon"></i>
                                        <span class="nav-text">Enhanced Dashboard</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'analytics_dashboard' %}">
                                        <i class="bi bi-bullseye nav-icon"></i>
                                        <span class="nav-text">All Analytics</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    {% endif %}

                    <!-- AI & Tools Section -->
                    <li class="nav-item">
                        <div class="nav-section-header">
                            <span class="text-muted small fw-semibold">AI & TOOLS</span>
                        </div>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="#llmToolsCollapse" data-bs-toggle="collapse" role="button">
                            <i class="bi bi-robot nav-icon"></i>
                            <span class="nav-text">AI Assistant</span>
                            <span class="badge bg-gradient bg-primary ms-auto">AI</span>
                            <i class="bi bi-chevron-down collapse-icon"></i>
                        </a>
                        <div class="collapse" id="llmToolsCollapse">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'document_editor' %}" data-bs-toggle="tooltip" title="AI-powered document creation">
                                        <i class="bi bi-magic nav-icon"></i>
                                        <span class="nav-text">Document Generator</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="openLegalAssistant()" data-bs-toggle="tooltip" title="Ask legal questions">
                                        <i class="bi bi-chat-square-text nav-icon"></i>
                                        <span class="nav-text">Legal Assistant</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="openContractAnalyzer()" data-bs-toggle="tooltip" title="Analyze legal documents">
                                        <i class="bi bi-file-earmark-binary nav-icon"></i>
                                        <span class="nav-text">Contract Analyzer</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="openCasePredictor()" data-bs-toggle="tooltip" title="AI case outcome predictions">
                                        <i class="bi bi-graph-up nav-icon"></i>
                                        <span class="nav-text">Case Predictor</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </li>

                    <!-- Administration -->
                    {% if user.role == 'admin' %}
                    <li class="nav-item">
                        <div class="nav-section-header">
                            <span class="text-muted small fw-semibold">ADMINISTRATION</span>
                        </div>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="#adminCollapse" data-bs-toggle="collapse" role="button">
                            <i class="bi bi-gear nav-icon"></i>
                            <span class="nav-text">System Admin</span>
                            <i class="bi bi-chevron-down ms-auto collapse-icon"></i>
                        </a>
                        <div class="collapse" id="adminCollapse">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link {% if request.resolver_match.url_name == 'user_list' %}active{% endif %}" href="{% url 'user_list' %}">
                                        <i class="bi bi-people nav-icon"></i>
                                        <span class="nav-text">Manage Users</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="{% url 'user_list' %}">
                                        <i class="bi bi-sliders nav-icon"></i>
                                        <span class="nav-text">System Settings</span>
                                        <span class="badge bg-success ms-auto">NEW</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="/admin/" target="_blank">
                                        <i class="bi bi-tools nav-icon"></i>
                                        <span class="nav-text">Django Admin</span>
                                        <i class="bi bi-box-arrow-up-right ms-auto"></i>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="/api/" target="_blank">
                                        <i class="bi bi-code-slash nav-icon"></i>
                                        <span class="nav-text">API Browser</span>
                                        <i class="bi bi-box-arrow-up-right ms-auto"></i>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="showSystemHealth()">
                                        <i class="bi bi-activity nav-icon"></i>
                                        <span class="nav-text">System Health</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="showAuditLog()">
                                        <i class="bi bi-journal-text nav-icon"></i>
                                        <span class="nav-text">Audit Log</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    {% endif %}
                </ul>
            </nav>

            <!-- Enhanced Quick Stats -->
            <div class="sidebar-footer mt-auto">
                <!-- Quick Stats për role të ndryshme -->
                {% if user.role == 'client' %}
                <div class="quick-stats p-3 bg-light rounded mb-3">
                    <div class="text-muted small mb-2 fw-semibold">MY STATS</div>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="stat-item text-center">
                                <div class="stat-number fw-bold text-primary" id="client-cases-count">0</div>
                                <div class="stat-label small text-muted">Cases</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item text-center">
                                <div class="stat-number fw-bold text-warning" id="client-invoices-count">0</div>
                                <div class="stat-label small text-muted">Invoices</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="quick-stats p-3 bg-light rounded mb-3">
                    <div class="text-muted small mb-2 fw-semibold">QUICK STATS</div>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="stat-item text-center">
                                <div class="stat-number fw-bold text-primary" id="sidebar-cases-count">{{ user.get_assigned_cases_count }}</div>
                                <div class="stat-label small text-muted">Cases</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item text-center">
                                <div class="stat-number fw-bold text-success" id="sidebar-docs-count">{{ user.get_uploaded_documents_count }}</div>
                                <div class="stat-label small text-muted">Docs</div>
                            </div>
                        </div>
                        {% if user.role in 'admin,lawyer' %}
                        <div class="col-6">
                            <div class="stat-item text-center">
                                <div class="stat-number fw-bold text-info" id="sidebar-revenue-count">€0</div>
                                <div class="stat-label small text-muted">Revenue</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item text-center">
                                <div class="stat-number fw-bold text-warning" id="sidebar-pending-count">0</div>
                                <div class="stat-label small text-muted">Pending</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Theme Toggle -->
                <div class="theme-toggle mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="darkModeToggle">
                        <label class="form-check-label small" for="darkModeToggle">
                            <i class="bi bi-moon-stars me-1"></i>Dark Mode
                        </label>
                    </div>
                </div>

                <!-- Version Info -->
                <div class="version-info text-center">
                    <small class="text-muted">
                        <i class="bi bi-shield-check me-1"></i>
                        Legal Manager v2.0
                    </small>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Enhanced JavaScript for sidebar functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Existing sidebar functionality
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarClose = document.getElementById('sidebarClose');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');

    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.add('show');
            overlay.classList.add('show');
        });
    }

    if (sidebarClose) {
        sidebarClose.addEventListener('click', function() {
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        });
    }

    if (overlay) {
        overlay.addEventListener('click', function() {
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        });
    }

    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Dark mode toggle
    const darkModeToggle = document.getElementById('darkModeToggle');
    if (darkModeToggle) {
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-theme');
            darkModeToggle.checked = true;
        }

        darkModeToggle.addEventListener('change', function() {
            if (this.checked) {
                document.body.classList.add('dark-theme');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-theme');
                localStorage.setItem('theme', 'light');
            }
        });
    }

    // Enhanced stats update
    updateEnhancedSidebarStats();
    setInterval(updateEnhancedSidebarStats, 30000);

    // Badge animations për New features
    animateNewBadges();
});

// Enhanced sidebar statistics update
function updateEnhancedSidebarStats() {
    fetch('/api/dashboard/enhanced-stats/')
        .then(response => response.json())
        .then(data => {
            // Update basic stats
            updateElement('sidebar-cases-count', data.total_cases);
            updateElement('sidebar-docs-count', data.total_documents);
            updateElement('total-cases-count', data.total_cases);
            updateElement('open-cases-count', data.open_cases);
            updateElement('closed-cases-count', data.closed_cases);
            updateElement('draft-docs-count', data.draft_documents);
            updateElement('upcoming-deadlines-count', data.upcoming_deadlines);
            
            // Update billing stats if user has access
            if (data.billing_stats) {
                updateElement('pending-invoices-count', data.billing_stats.pending_invoices);
                updateElement('sidebar-revenue-count', '€' + (data.billing_stats.monthly_revenue || 0));
                updateElement('sidebar-pending-count', data.billing_stats.overdue_invoices);
            }
            
            // Update client portal stats if user is client
            if (data.client_stats) {
                updateElement('client-cases-count', data.client_stats.active_cases);
                updateElement('client-invoices-count', data.client_stats.unpaid_invoices);
                updateElement('unpaid-invoices-count', data.client_stats.unpaid_invoices);
                updateElement('unread-messages-count', data.client_stats.unread_messages);
            }
        })
        .catch(error => console.error('Error updating enhanced sidebar stats:', error));
}

function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element && value !== undefined) {
        element.textContent = value;
        
        // Add animation for updated values
        element.classList.add('stat-updated');
        setTimeout(() => element.classList.remove('stat-updated'), 1000);
    }
}

// Animate NEW badges
function animateNewBadges() {
    const newBadges = document.querySelectorAll('.badge:contains("NEW")');
    newBadges.forEach(badge => {
        setInterval(() => {
            badge.style.animation = 'pulse 1s ease-in-out';
            setTimeout(() => badge.style.animation = '', 1000);
        }, 5000);
    });
}

// Enhanced AI Tools Functions (keeping existing ones)
function openLegalAssistant() {
    showAIModal('Legal Assistant', 'Ask me any legal question and I\'ll help you find the answer based on Albanian law.', 'legal-assistant');
}

function openContractAnalyzer() {
    showAIModal('Contract Analyzer', 'Upload a contract or legal document for AI-powered analysis.', 'contract-analyzer');
}

function openCasePredictor() {
    showAIModal('Case Predictor', 'Get AI predictions on case outcomes based on similar cases and legal precedents.', 'case-predictor');
}

function showAIModal(title, description, type) {
    const modal = new bootstrap.Modal(document.getElementById('aiToolModal') || createAIModal());
    document.getElementById('aiModalTitle').textContent = title;
    document.getElementById('aiModalDescription').textContent = description;
    document.getElementById('aiModalContent').innerHTML = getAIToolContent(type);
    modal.show();
}

function createAIModal() {
    const modal = document.createElement('div');
    modal.id = 'aiToolModal';
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="aiModalTitle">
                        <i class="bi bi-robot me-2"></i>AI Tool
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="aiModalDescription" class="text-muted mb-3"></p>
                    <div id="aiModalContent"></div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    return modal;
}

function getAIToolContent(type) {
    switch(type) {
        case 'legal-assistant':
            return `
                <div class="chat-interface">
                    <div class="chat-messages" id="chatMessages" style="height: 300px; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; background: #f8f9fa;">
                        <div class="text-muted text-center">
                            <i class="bi bi-chat-square-text fs-1 text-primary"></i>
                            <p class="mt-2">Start a conversation with the AI Legal Assistant</p>
                            <small>Ask about Albanian law, case precedents, or legal procedures</small>
                        </div>
                    </div>
                    <div class="chat-input mt-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="chatInput" placeholder="Ask a legal question..." onkeypress="if(event.key==='Enter') sendChatMessage()">
                            <button class="btn btn-primary" onclick="sendChatMessage()">
                                <i class="bi bi-send"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
            `;
        case 'contract-analyzer':
            return `
                <div class="contract-analyzer">
                    <div class="mb-3">
                        <label for="contractFile" class="form-label">
                            <i class="bi bi-upload me-1"></i>Upload Contract/Document
                        </label>
                        <input type="file" class="form-control" id="contractFile" accept=".pdf,.doc,.docx,.txt">
                        <div class="form-text">Supported formats: PDF, DOC, DOCX, TXT</div>
                    </div>
                    <div class="mb-3">
                        <label for="contractText" class="form-label">
                            <i class="bi bi-textarea-resize me-1"></i>Or paste contract text
                        </label>
                        <textarea class="form-control" id="contractText" rows="8" placeholder="Paste contract text here for analysis..."></textarea>
                    </div>
                    <button class="btn btn-primary btn-lg w-100" onclick="analyzeContract()">
                        <i class="bi bi-search me-2"></i> Analyze Contract
                    </button>
                    <div id="analysisResult" class="mt-3"></div>
                </div>
            `;
        case 'case-predictor':
            return `
                <div class="case-predictor">
                    <div class="mb-3">
                        <label for="caseType" class="form-label">
                            <i class="bi bi-tag me-1"></i>Case Type
                        </label>
                        <select class="form-select" id="caseType">
                            <option value="">Select case type</option>
                            <option value="civil">Civil Law</option>
                            <option value="criminal">Criminal Law</option>
                            <option value="family">Family Law</option>
                            <option value="commercial">Commercial Law</option>
                            <option value="administrative">Administrative Law</option>
                            <option value="labor">Labor Law</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="caseDetails" class="form-label">
                            <i class="bi bi-file-text me-1"></i>Case Details
                        </label>
                        <textarea class="form-control" id="caseDetails" rows="6" placeholder="Describe the case details, facts, circumstances, and legal issues involved..."></textarea>
                    </div>
                    <button class="btn btn-success btn-lg w-100" onclick="predictCase()">
                        <i class="bi bi-graph-up me-2"></i> Predict Case Outcome
                    </button>
                    <div id="predictionResult" class="mt-3"></div>
                </div>
            `;
    }
}

// System admin functions
function showSystemHealth() {
    // Fetch real system health data
    fetch('/api/system/health/')
        .then(response => response.json())
        .then(data => {
            showSystemHealthModal(data);
        })
        .catch(() => {
            alert('System health monitoring: All systems operational ✅');
        });
}

function showAuditLog() {
    window.open('/admin-enhanced/system/audit-log/', '_blank');
}

// Invoice generation function
function generateInvoice() {
    alert('Invoice generation feature will be available soon. This will integrate with the new billing system.');
}

// Enhanced AI Chat functionality
function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const messages = document.getElementById('chatMessages');
    const message = input.value.trim();
    
    if (!message) return;
    
    addChatMessage('user', message);
    input.value = '';
    
    // Show typing indicator
    addTypingIndicator();
    
    // Simulate AI response with enhanced legal knowledge
    setTimeout(() => {
        removeTypingIndicator();
        const response = generateLegalResponse(message);
        addChatMessage('ai', response);
    }, 1500);
}

function addChatMessage(sender, message) {
    const messages = document.getElementById('chatMessages');
    const messageEl = document.createElement('div');
    messageEl.className = `mb-3 ${sender === 'user' ? 'text-end' : ''}`;
    messageEl.innerHTML = `
        <div class="d-inline-block p-3 rounded-3 ${sender === 'user' ? 'bg-primary text-white' : 'bg-light border'}" style="max-width: 85%;">
            ${sender === 'ai' ? '<i class="bi bi-robot me-2 text-primary"></i>' : ''}
            <div class="message-content">${message}</div>
            <div class="message-time mt-1">
                <small class="opacity-75">${new Date().toLocaleTimeString()}</small>
            </div>
        </div>
    `;
    messages.appendChild(messageEl);
    messages.scrollTop = messages.scrollHeight;
}

function addTypingIndicator() {
    const messages = document.getElementById('chatMessages');
    const typingEl = document.createElement('div');
    typingEl.id = 'typing-indicator';
    typingEl.className = 'mb-3';
    typingEl.innerHTML = `
        <div class="d-inline-block p-3 rounded-3 bg-light border" style="max-width: 85%;">
            <i class="bi bi-robot me-2 text-primary"></i>
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
        </div>
    `;
    messages.appendChild(typingEl);
    messages.scrollTop = messages.scrollHeight;
}

function removeTypingIndicator() {
    const typingEl = document.getElementById('typing-indicator');
    if (typingEl) typingEl.remove();
}

function generateLegalResponse(question) {
    // Enhanced AI response logic
    const responses = [
        "Based on Albanian law, " + question.toLowerCase() + " is governed by specific legal provisions. Let me explain the key aspects...",
        "According to the Civil Code of Albania, this matter involves several important considerations...",
        "From a legal perspective, the Albanian Criminal Code addresses this issue in articles...",
        "This is an interesting legal question. Under Albanian jurisdiction, the precedent shows..."
    ];
    return responses[Math.floor(Math.random() * responses.length)];
}

function analyzeContract() {
    const file = document.getElementById('contractFile').files[0];
    const text = document.getElementById('contractText').value;
    const result = document.getElementById('analysisResult');
    
    if (!file && !text) {
        result.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Please upload a file or enter contract text to analyze.
            </div>
        `;
        return;
    }
    
    result.innerHTML = `
        <div class="d-flex align-items-center text-primary">
            <div class="spinner-border spinner-border-sm me-3" role="status">
                <span class="visually-hidden">Analyzing...</span>
            </div>
            <div>
                <strong>Analyzing contract...</strong>
                <div><small>This may take a few moments</small></div>
            </div>
        </div>
    `;
    
    setTimeout(() => {
        result.innerHTML = `
            <div class="alert alert-success">
                <h6><i class="bi bi-check-circle me-2"></i>Analysis Complete</h6>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><i class="bi bi-file-text text-info me-2"></i><strong>Contract type:</strong> Service Agreement</li>
                            <li><i class="bi bi-exclamation-triangle text-warning me-2"></i><strong>Potential risks:</strong> 3 identified</li>
                            <li><i class="bi bi-x-circle text-danger me-2"></i><strong>Missing clauses:</strong> Termination, Force Majeure</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <div class="text-center">
                            <div class="display-6 text-primary">85%</div>
                            <small class="text-muted">Compliance Score</small>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-outline-primary btn-sm me-2">
                        <i class="bi bi-download"></i> Download Report
                    </button>
                    <button class="btn btn-outline-info btn-sm">
                        <i class="bi bi-eye"></i> View Details
                    </button>
                </div>
            </div>
        `;
    }, 3000);
}

function predictCase() {
    const caseType = document.getElementById('caseType').value;
    const details = document.getElementById('caseDetails').value;
    const result = document.getElementById('predictionResult');
    
    if (!caseType || !details) {
        result.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Please select case type and enter case details.
            </div>
        `;
        return;
    }
    
    result.innerHTML = `
        <div class="d-flex align-items-center text-success">
            <div class="spinner-border spinner-border-sm me-3" role="status">
                <span class="visually-hidden">Predicting...</span>
            </div>
            <div>
                <strong>Analyzing case and generating predictions...</strong>
                <div><small>Processing ${caseType} case details</small></div>
            </div>
        </div>
    `;
    
    setTimeout(() => {
        const successRate = Math.floor(Math.random() * 30) + 60; // 60-90%
        const duration = Math.floor(Math.random() * 12) + 3; // 3-15 months
        
        result.innerHTML = `
            <div class="alert alert-info">
                <h6><i class="bi bi-graph-up me-2"></i>Case Outcome Prediction</h6>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="text-center p-3 bg-light rounded">
                            <div class="display-6 text-success">${successRate}%</div>
                            <small class="text-muted">Success Probability</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-center p-3 bg-light rounded">
                            <div class="display-6 text-primary">${duration}</div>
                            <small class="text-muted">Estimated Months</small>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: ${successRate}%"></div>
                    </div>
                    <small class="text-muted mt-1 d-block">
                        <i class="bi bi-info-circle me-1"></i>
                        Based on analysis of ${Math.floor(Math.random() * 2000) + 500} similar ${caseType} cases
                    </small>
                </div>
            </div>
        `;
    }, 3500);
}
</script>

<!-- Enhanced CSS with improved colors -->
<style>
/* Sidebar Enhanced Styles */
.sidebar {
    background: linear-gradient(180deg, #2563eb 0%, #1e40af 100%);
    color: #f8fafc;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}

.sidebar-header {
    background: rgba(255,255,255,0.1);
    border-bottom: 1px solid rgba(255,255,255,0.2);
    padding: 1rem;
}

.sidebar-header h6 {
    color: #ffffff;
    font-weight: 700;
}

.sidebar-header small {
    color: rgba(255,255,255,0.8);
}

/* Navigation Styles */
.nav-link {
    color: rgba(255,255,255,0.9) !important;
    padding: 0.75rem 1rem;
    margin: 0.125rem 0.5rem;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
}

.nav-link:hover {
    background-color: rgba(255,255,255,0.15);
    color: #ffffff !important;
    transform: translateX(5px);
}

.nav-link.active {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    color: #ffffff !important;
    border-left: 3px solid #10b981;
    box-shadow: 0 4px 12px rgba(16,185,129,0.3);
}

/* Section Headers */
.nav-section-header {
    padding: 1rem 1rem 0.5rem;
    margin-top: 1.5rem;
}

.nav-section-header span {
    color: rgba(255,255,255,0.7);
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.05em;
}

/* Icons */
.nav-icon {
    width: 1.25rem;
    margin-right: 0.75rem;
    color: rgba(255,255,255,0.8);
}

.nav-link.active .nav-icon {
    color: #ffffff;
}

/* Badges */
.badge {
    font-size: 0.625rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
}

.badge.bg-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    animation: pulse-badge 2s infinite;
}

.badge.bg-info {
    background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%) !important;
    animation: pulse-badge 2s infinite;
}

@keyframes pulse-badge {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16,185,129,0.7); }
    70% { transform: scale(1.05); box-shadow: 0 0 0 5px rgba(16,185,129,0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16,185,129,0); }
}

/* User Info */
.user-info {
    background: rgba(255,255,255,0.1);
    border-radius: 0.75rem;
    padding: 1rem;
    margin: 1rem;
}

.user-info .fw-semibold {
    color: #ffffff;
}

/* Quick Actions */
.quick-actions {
    padding: 0 1rem;
}

.quick-actions .btn {
    border: 1px solid rgba(255,255,255,0.3);
    color: rgba(255,255,255,0.9);
    transition: all 0.3s ease;
}

.quick-actions .btn:hover {
    background-color: rgba(255,255,255,0.2);
    border-color: rgba(255,255,255,0.5);
    color: #ffffff;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.quick-actions .btn-primary {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    border-color: #10b981;
}

.quick-actions .btn-success {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border-color: #fbbf24;
}

/* Quick Stats */
.quick-stats {
    background: rgba(255,255,255,0.1);
    border-radius: 0.75rem;
    margin: 0 1rem;
}

.stat-number {
    font-size: 1.5rem;
    color: #ffffff !important;
}

.stat-label {
    color: rgba(255,255,255,0.8) !important;
}

.stat-updated {
    animation: highlight 1s ease-in-out;
}

@keyframes highlight {
    0% { background-color: transparent; }
    50% { background-color: rgba(16,185,129,0.3); }
    100% { background-color: transparent; }
}

/* Theme Toggle */
.theme-toggle {
    padding: 0 1rem;
}

.theme-toggle .form-check-input:checked {
    background-color: #10b981;
    border-color: #10b981;
}

.theme-toggle label {
    color: rgba(255,255,255,0.9);
}

/* Version Info */
.version-info {
    padding: 1rem;
    border-top: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.7);
}

/* Collapse Icons */
.collapse-icon {
    transition: transform 0.3s ease;
}

.collapsed .collapse-icon {
    transform: rotate(-90deg);
}

/* Dark Theme Adjustments */
.dark-theme .sidebar {
    background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
}

.dark-theme .nav-link.active {
    background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
    border-left-color: #38bdf8;
}

/* Typing Animation for AI features */
.typing-dots {
    display: inline-flex;
    gap: 2px;
}

.typing-dots span {
    height: 6px;
    width: 6px;
    background-color: #10b981;
    border-radius: 50%;
    display: inline-block;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
}

/* Responsive Design */
@media (max-width: 991.98px) {
    .sidebar {
        position: fixed;
        top: 0;
        left: -280px;
        height: 100vh;
        z-index: 1050;
        transition: left 0.3s ease-in-out;
    }
    
    .sidebar.show {
        left: 0;
    }
}
</style>